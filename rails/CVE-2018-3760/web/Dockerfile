FROM ubuntu:18.04


ENV DEBIAN_FRONTEND=noninteractive
ENV PATH /usr/local/rbenv/bin:$PATH
ENV RBENV_ROOT /usr/local/rbenv
ENV PATH /usr/local/rbenv/bin:/usr/local/rbenv/shims:$PATH

RUN apt-get update \
    && apt-get upgrade -y \
    && apt-get install -y tzdata nodejs sqlite3 libsqlite3-dev git build-essential curl zlib1g-dev libssl-dev libreadline-dev libyaml-dev libxml2-dev libxslt-dev \
    && apt-get clean \
    && ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone \
    && apt-get clean \
    && cd /root \
    && git clone git://github.com/rbenv/rbenv.git /usr/local/rbenv \
    && git clone git://github.com/rbenv/ruby-build.git /usr/local/rbenv/plugins/ruby-build \
    && git clone git://github.com/jf/rbenv-gemset.git /usr/local/rbenv/plugins/rbenv-gemset \
    && /usr/local/rbenv/plugins/ruby-build/install.sh \
    && echo 'export RBENV_ROOT=/usr/local/rbenv' >> /etc/profile.d/rbenv.sh \
    && echo 'export PATH=/usr/local/rbenv/bin:$PATH' >> /etc/profile.d/rbenv.sh \
    && echo 'eval "$(rbenv init -)"' >> /etc/profile.d/rbenv.sh \
    && echo 'export RBENV_ROOT=/usr/local/rbenv' >> /root/.bashrc \
    && echo 'export PATH=/usr/local/rbenv/bin:$PATH' >> /root/.bashrc \
    && echo 'eval "$(rbenv init -)"' >> /root/.bashrc \
    && eval "$(rbenv init -)"; rbenv install 2.4.4 \
    && eval "$(rbenv init -)"; rbenv global 2.4.4 \
    && eval "$(rbenv init -)"; gem install rails -v 5.2.3 \
    && eval "$(rbenv init -)"; rails new blog \
    && cd blog \
    && sed -ie 's/sprockets (3.*)/sprockets (3.7.1)/g' /root/blog/Gemfile.lock \
    && echo "gem 'sprockets', '3.7.1'" >> /root/blog/Gemfile \
    && sed -ie 's/config.assets.compile = false/config.assets.compile = true/g' /root/blog/config/environments/production.rb \
    && eval "$(rbenv init -)"; bundle install

WORKDIR /root/blog

CMD ["rails","server","-b", "0.0.0.0"]

